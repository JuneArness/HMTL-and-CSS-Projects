//legacy vars
var globalDestination = "bellmedia_web";
var globalPlatform = "desktop";

var bmPlayerConfig = player_config.bmPlayerConfig;


function initAuth () {

    var brand = 'ctv';
    var platform = 'web';
    var environment = 'prod';

    BmAuth.init(brand, platform, environment, { disableLogs: false, fulfillOnClose: true, closeModalOnOutsideClick: true })
        .then( function() {
            return true;
        })
        .catch( function(errorPackage) { console.log('[tester] init failed', errorPackage); });
}

/**
 * main shortcode
 */
(function($) {

    initAuth();

    $('.video-container').each(function(index, element){

        var element = $(element);
        var video_id = element.attr('data-videoid');
        var container_id = element.attr('id');
        var autoplay = element.attr('data-autoplay');

        var BmPlayer = new BMVidiPlayer({
            container: '#'+container_id,
            config:    bmPlayerConfig
        }, [video_id]);

        BmPlayer.on('PLAYER_READY', function(){
            triggerVideoIsPlaying(BmPlayer, video_id);
            console.log('player is ready');
            if(autoplay === 'true') {
                BmPlayer.play();
            }
        });
    });
})(jQuery);


/**
 * Legacy BmPlayer object.
 */
(function($) {

    this.BmPlayer = function(container, globalDestination, globalPlatform) {
        this.container = container;
        this.isEmbed = false;
        this.videoPlayer = null;
    };

    BmPlayer.prototype.embedPlayer = function(autoplay) {

        this._log("new player: embeding player : " + (this.container.data('id')) + " - " + (this.container.attr('id')));

        //upfront quick fix for switching to guess login on sign in
        if ( $('body').hasClass('page-template-homefront-blade') && window.BmAuth != null ) { 
            $(document).on('click', '.signin-to-watch', function(){
                setTimeout(function(){
                    var div = $('.auth9_btnBMG').first()[0];
                    if (div) { 
                        div.click();
                    } else {
                        console.log('BmPlayer warning: .auth9_btnBMG not found');
                    }
                },300)
            });
        };

        if (this.isEmbed) {
            return;
        }

        var videoId = this.container.data('id');

        var videoPlayer = new BMVidiPlayer({
            container: '#'+this.container.attr('id'),
            config:    bmPlayerConfig
        }, [videoId]);

        this.videoPlayer = videoPlayer;

        videoPlayer.on('PLAYER_READY', function(){

            triggerVideoIsPlaying(videoPlayer, videoId);

            if (autoplay === true) {
                videoPlayer.play();
            }

            var box = $('.ilightbox-holder');
            if (box[0]) {
                // jquery .css() doesn't support !important.
                box[0].style.setProperty('display', 'block', 'important');
            } else {
                console.log('BmPlayer warning: .ilightbox-holder not found');
            }

            videoPlayer.on('PLAYBACK_COMPLETE', function(){

                videoPlayer.destroy();
                videoPlayer = undefined;

                //reference to ilightbox is lost - deleting the old fashioned way
                $( "body > div[class*='ilightbox']" ).each( function(){ $(this).remove() } );
                $('body').removeClass('ilightbox-noscroll');

            });
        });

        this.isEmbed = true;
        return this.isEmbed;
    };

    BmPlayer.prototype._log = function(str) {
        console.log(str);
    };

}).call(this, jQuery);

function triggerVideoIsPlaying(BmPlayer, videoId){
    jQuery(window).trigger('bmplayer:ready', [BmPlayer]);
}
